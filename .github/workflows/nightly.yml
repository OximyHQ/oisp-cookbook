# Nightly Test Suite
#
# Runs all examples every night to ensure the sensor works with real APIs.
# This is our source of truth for "does OISP actually work?"

name: Nightly Tests

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      sensor_version:
        description: 'Sensor version to test (default: latest)'
        required: false
        default: 'latest'

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  # Download sensor once, share with all jobs
  setup:
    runs-on: ubuntu-latest
    outputs:
      sensor-version: ${{ steps.download.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Download OISP Sensor
        id: download
        run: |
          VERSION="${{ github.event.inputs.sensor_version || 'latest' }}"
          ./shared/scripts/download-sensor.sh $VERSION
          echo "version=$(./bin/oisp-sensor --version | head -1)" >> $GITHUB_OUTPUT

      - name: Upload sensor binary
        uses: actions/upload-artifact@v4
        with:
          name: oisp-sensor
          path: bin/oisp-sensor
          retention-days: 1

  # Auto-discover cookbooks
  discover:
    runs-on: ubuntu-latest
    outputs:
      cookbooks: ${{ steps.discover.outputs.cookbooks }}
    steps:
      - uses: actions/checkout@v4

      - name: Discover cookbooks
        id: discover
        run: |
          # Generate JSON array for matrix
          ./shared/scripts/discover-cookbooks.sh | \
            jq -R -s 'split("\n")[:-1] | map({name: (.|gsub("/";"-")), path: .})' \
            > cookbooks.json
          echo "cookbooks=$(cat cookbooks.json)" >> $GITHUB_OUTPUT

          # Show discovered cookbooks
          echo "Discovered cookbooks:"
          cat cookbooks.json | jq -r '.[].path'

  # Test matrix - each cookbook runs in parallel
  test-matrix:
    needs: [setup, discover]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Run all tests, report all failures (strict policy)
      matrix:
        cookbook: ${{ fromJson(needs.discover.outputs.cookbooks) }}

    steps:
      - uses: actions/checkout@v4

      - name: Download sensor binary
        uses: actions/download-artifact@v4
        with:
          name: oisp-sensor
          path: bin/

      - name: Make sensor executable
        run: chmod +x bin/oisp-sensor

      - name: Setup Python
        if: startsWith(matrix.cookbook.path, 'python/')
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        if: startsWith(matrix.cookbook.path, 'node/')
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run ${{ matrix.cookbook.name }}
        env:
          OISP_SENSOR_BIN: ${{ github.workspace }}/bin/oisp-sensor
        run: |
          ./shared/scripts/run-cookbook-test.sh ${{ matrix.cookbook.path }}

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.cookbook.name }}
          path: ${{ matrix.cookbook.path }}/output/
          retention-days: 7

  # Kubernetes tests (separate job - requires k3d)
  test-kubernetes:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python (for validation)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install k3d
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Run kubernetes/daemonset test
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cd kubernetes/daemonset
          chmod +x test.sh
          ./test.sh

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-kubernetes-daemonset
          path: kubernetes/daemonset/output/
          retention-days: 7

  # Summary report
  report:
    needs: [setup, test-matrix, test-kubernetes]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Nightly Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Sensor Version:** ${{ needs.setup.outputs.sensor-version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See individual job results above for details." >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "Tests failed! Consider adding Slack/Discord notification here."

