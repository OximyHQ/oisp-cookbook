# Nightly Test Suite
#
# Runs all examples every night to ensure the sensor works with real APIs.
# This is our source of truth for "does OISP actually work?"
#
# Each cookbook has a self-contained Dockerfile.test that builds the sensor
# from source and runs tests in an isolated environment.

name: Nightly Tests

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      sensor_ref:
        description: 'oisp-sensor git ref to test (branch, tag, or SHA)'
        required: false
        default: 'main'

# Minimal permissions for security
permissions:
  contents: read
  actions: read

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  # Auto-discover cookbooks that have Dockerfile.test
  discover:
    runs-on: ubuntu-latest
    outputs:
      cookbooks: ${{ steps.discover.outputs.cookbooks }}
    steps:
      - uses: actions/checkout@v4

      - name: Discover cookbooks with Dockerfile.test
        id: discover
        run: |
          # Find all cookbooks with Dockerfile.test (excludes kubernetes which has its own test)
          COOKBOOKS=$(find . -name "Dockerfile.test" -not -path "./kubernetes/*" \
            -exec dirname {} \; | sed 's|^\./||' | sort | \
            jq -R -s -c 'split("\n")[:-1] | map({name: (.|gsub("/";"-")), path: .})')
          echo "cookbooks=$COOKBOOKS" >> $GITHUB_OUTPUT

          echo "Discovered cookbooks with Dockerfile.test:"
          echo "$COOKBOOKS" | jq -r '.[].path'

  # Test matrix - each cookbook runs in parallel using Docker
  test-matrix:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Run all tests, report all failures
      matrix:
        cookbook: ${{ fromJson(needs.discover.outputs.cookbooks) }}

    steps:
      - name: Checkout cookbook repo
        uses: actions/checkout@v4
        with:
          path: oisp-cookbook

      - name: Checkout sensor repo
        uses: actions/checkout@v4
        with:
          repository: OximyHQ/oisp-sensor
          ref: ${{ github.event.inputs.sensor_ref || 'main' }}
          path: oisp-sensor
          submodules: recursive

      - name: Get sensor version
        id: sensor-version
        run: |
          cd oisp-sensor
          VERSION=$(git describe --tags --always 2>/dev/null || git rev-parse --short HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Testing with sensor: $VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        run: |
          COOKBOOK="${{ matrix.cookbook.path }}"
          IMAGE_NAME="oisp-test-$(echo $COOKBOOK | tr '/' '-'):latest"

          echo "Building: $IMAGE_NAME"
          docker build \
            -f "oisp-cookbook/$COOKBOOK/Dockerfile.test" \
            -t "$IMAGE_NAME" \
            --build-context oisp-sensor=oisp-sensor \
            --build-context oisp-cookbook=oisp-cookbook \
            .

      - name: Run test
        run: |
          COOKBOOK="${{ matrix.cookbook.path }}"
          IMAGE_NAME="oisp-test-$(echo $COOKBOOK | tr '/' '-'):latest"

          mkdir -p output

          echo "Running: $COOKBOOK"
          docker run --rm --privileged \
            -e OPENAI_API_KEY="$OPENAI_API_KEY" \
            -e ANTHROPIC_API_KEY="$ANTHROPIC_API_KEY" \
            -v "$(pwd)/output:/output" \
            "$IMAGE_NAME"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.cookbook.name }}
          path: output/
          retention-days: 7

  # Kubernetes tests (separate job - requires k3d)
  test-kubernetes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cookbook repo
        uses: actions/checkout@v4
        with:
          path: oisp-cookbook

      - name: Checkout sensor repo
        uses: actions/checkout@v4
        with:
          repository: OximyHQ/oisp-sensor
          ref: ${{ github.event.inputs.sensor_ref || 'main' }}
          path: oisp-sensor
          submodules: recursive

      - name: Setup Python (for validation)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install k3d
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Run kubernetes/daemonset test
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cd oisp-cookbook/kubernetes/daemonset
          chmod +x test.sh
          ./test.sh

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-kubernetes-daemonset
          path: oisp-cookbook/kubernetes/daemonset/output/
          retention-days: 7

  # Summary report
  report:
    needs: [discover, test-matrix, test-kubernetes]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Nightly Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Sensor Ref:** ${{ github.event.inputs.sensor_ref || 'main' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See individual job results above for details." >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "Tests failed! Consider adding Slack/Discord notification here."

