# Sensor Release Validation
#
# Triggered by oisp-sensor when a new release is created.
# Validates that the new release works with ALL cookbooks (strict quality gate).
#
# Uses Docker-based testing with self-contained Dockerfile.test for each cookbook.

name: Release Validation

on:
  repository_dispatch:
    types: [sensor-release]
  workflow_dispatch:
    inputs:
      sensor_ref:
        description: 'oisp-sensor git ref to test (tag, branch, or SHA)'
        required: true
        default: 'main'

# Minimal permissions for security
permissions:
  contents: read
  actions: read

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  # Get sensor ref from dispatch or input
  setup:
    runs-on: ubuntu-latest
    outputs:
      sensor-ref: ${{ steps.ref.outputs.ref }}
    steps:
      - name: Get sensor ref
        id: ref
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            REF="${{ github.event.client_payload.ref || github.event.client_payload.version }}"
          else
            REF="${{ github.event.inputs.sensor_ref }}"
          fi
          echo "ref=$REF" >> $GITHUB_OUTPUT
          echo "Testing sensor ref: $REF"

  # Auto-discover all cookbooks with Dockerfile.test
  discover:
    runs-on: ubuntu-latest
    outputs:
      cookbooks: ${{ steps.discover.outputs.cookbooks }}
    steps:
      - uses: actions/checkout@v4

      - name: Discover cookbooks with Dockerfile.test
        id: discover
        run: |
          # Find all cookbooks with Dockerfile.test (including kubernetes)
          COOKBOOKS=$(find . -name "Dockerfile.test" \
            -exec dirname {} \; | sed 's|^\./||' | sort | \
            jq -R -s -c 'split("\n")[:-1] | map({name: (.|gsub("/";"-")), path: .})')
          echo "cookbooks=$COOKBOOKS" >> $GITHUB_OUTPUT

          echo "Release validation will test ALL cookbooks:"
          echo "$COOKBOOKS" | jq -r '.[].path'

  # Test all cookbooks with new sensor version
  validate:
    needs: [setup, discover]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Test all cookbooks, report all failures
      matrix:
        cookbook: ${{ fromJson(needs.discover.outputs.cookbooks) }}

    steps:
      - name: Checkout cookbook repo
        uses: actions/checkout@v4
        with:
          path: oisp-cookbook

      - name: Checkout sensor repo
        uses: actions/checkout@v4
        with:
          repository: oximyhq/sensor
          ref: ${{ needs.setup.outputs.sensor-ref }}
          path: oisp-sensor
          submodules: recursive

      - name: Get sensor version
        id: sensor-version
        run: |
          cd oisp-sensor
          VERSION=$(git describe --tags --always 2>/dev/null || git rev-parse --short HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Testing with sensor: $VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        run: |
          COOKBOOK="${{ matrix.cookbook.path }}"
          IMAGE_NAME="oisp-test-$(echo $COOKBOOK | tr '/' '-'):latest"

          echo "Building: $IMAGE_NAME"
          docker build \
            -f "oisp-cookbook/$COOKBOOK/Dockerfile.test" \
            -t "$IMAGE_NAME" \
            --build-context oisp-sensor=oisp-sensor \
            --build-context oisp-cookbook=oisp-cookbook \
            .

      - name: Run test
        run: |
          COOKBOOK="${{ matrix.cookbook.path }}"
          IMAGE_NAME="oisp-test-$(echo $COOKBOOK | tr '/' '-'):latest"

          mkdir -p output

          echo "Running: $COOKBOOK"

          # All tests need --privileged for eBPF/sslsniff to work
          # Kubernetes tests also need docker socket for k3d
          if [[ "$COOKBOOK" == kubernetes/* ]]; then
            docker run --rm --privileged \
              -e OPENAI_API_KEY="$OPENAI_API_KEY" \
              -e ANTHROPIC_API_KEY="$ANTHROPIC_API_KEY" \
              -v /var/run/docker.sock:/var/run/docker.sock \
              -v "$(pwd)/output:/output" \
              "$IMAGE_NAME"
          else
            docker run --rm --privileged \
              -e OPENAI_API_KEY="$OPENAI_API_KEY" \
              -e ANTHROPIC_API_KEY="$ANTHROPIC_API_KEY" \
              -v "$(pwd)/output:/output" \
              "$IMAGE_NAME"
          fi

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.cookbook.name }}
          path: output/
          retention-days: 7

  # Report results back to sensor repo
  report-back:
    needs: [setup, validate]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'repository_dispatch'
    steps:
      - name: Report success
        if: needs.validate.result == 'success'
        run: |
          echo "✅ All cookbook tests passed for sensor ${{ needs.setup.outputs.sensor-ref }}"
          # TODO: Update status check on sensor repo using GitHub API

      - name: Report failure
        if: needs.validate.result != 'success'
        run: |
          echo "❌ Cookbook validation failed for sensor ${{ needs.setup.outputs.sensor-ref }}"
          # TODO: Create issue or notify team
          exit 1
