# PR Validation
#
# Fast validation for pull requests - only tests changed cookbooks
# If shared infrastructure changes, tests all cookbooks

name: PR Validation

on:
  pull_request:
    paths:
      - 'python/**'
      - 'node/**'
      - 'edge-cases/**'
      - 'multi-process/**'
      - 'self-hosted/**'
      - 'kubernetes/**'
      - 'shared/**'
      - '.github/workflows/**'

# Minimal permissions for security
permissions:
  contents: read
  actions: read
  pull-requests: read

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  # Download sensor once, share with all jobs
  setup:
    runs-on: ubuntu-latest
    outputs:
      sensor-version: ${{ steps.download.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Download OISP Sensor
        id: download
        run: |
          ./shared/scripts/download-sensor.sh latest
          echo "version=$(./bin/oisp-sensor --version | head -1)" >> $GITHUB_OUTPUT

      - name: Upload sensor binary
        uses: actions/upload-artifact@v4
        with:
          name: oisp-sensor
          path: bin/oisp-sensor
          retention-days: 1

  # Detect which cookbooks changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      cookbooks: ${{ steps.detect.outputs.cookbooks }}
      test-all: ${{ steps.detect.outputs.test-all }}
      count: ${{ steps.detect.outputs.count }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed cookbooks
        id: detect
        run: |
          # Get changed files vs base branch
          git fetch origin ${{ github.base_ref }}
          changed=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          echo "Changed files:"
          echo "$changed"
          echo ""

          # If shared/ or .github/workflows/ changed, test all cookbooks
          if echo "$changed" | grep -qE '^(shared/|\.github/workflows/)'; then
            echo "Shared infrastructure changed - testing all cookbooks"
            echo "test-all=true" >> $GITHUB_OUTPUT
            cookbooks=$(./shared/scripts/discover-cookbooks.sh | \
              jq -R -s 'split("\n")[:-1] | map({name: (.|gsub("/";"-")), path: .})')
            echo "cookbooks=$cookbooks" >> $GITHUB_OUTPUT
            echo "count=$(echo "$cookbooks" | jq 'length')" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Find affected cookbooks (any file in cookbook directory changed)
          cookbooks=$(echo "$changed" | \
            grep -E '^(python|node|edge-cases|multi-process|self-hosted|kubernetes)/' | \
            cut -d/ -f1-2 | \
            sort -u | \
            jq -R -s 'split("\n")[:-1] | map(select(length > 0)) | map({name: (.|gsub("/";"-")), path: .})')

          echo "Affected cookbooks:"
          echo "$cookbooks" | jq -r '.[].path'

          echo "cookbooks=$cookbooks" >> $GITHUB_OUTPUT
          echo "test-all=false" >> $GITHUB_OUTPUT
          echo "count=$(echo "$cookbooks" | jq 'length')" >> $GITHUB_OUTPUT

  # Test changed cookbooks
  test-changed:
    needs: [setup, detect-changes]
    if: needs.detect-changes.outputs.count != '0'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        cookbook: ${{ fromJson(needs.detect-changes.outputs.cookbooks) }}

    steps:
      - uses: actions/checkout@v4

      - name: Download sensor binary
        uses: actions/download-artifact@v4
        with:
          name: oisp-sensor
          path: bin/

      - name: Make sensor executable
        run: chmod +x bin/oisp-sensor

      - name: Setup Python
        if: startsWith(matrix.cookbook.path, 'python/')
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        if: startsWith(matrix.cookbook.path, 'node/')
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run ${{ matrix.cookbook.name }}
        env:
          OISP_SENSOR_BIN: ${{ github.workspace }}/bin/oisp-sensor
        run: |
          ./shared/scripts/run-cookbook-test.sh ${{ matrix.cookbook.path }}

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.cookbook.name }}
          path: ${{ matrix.cookbook.path }}/output/
          retention-days: 7

  # Summary
  summary:
    needs: [detect-changes, test-changed]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## PR Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changes.outputs.test-all }}" = "true" ]; then
            echo "**Scope:** All cookbooks (shared infrastructure changed)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Scope:** Changed cookbooks only" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**Tested:** ${{ needs.detect-changes.outputs.count }} cookbook(s)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.test-changed.result }}" = "success" ]; then
            echo "✅ All tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some tests failed. Check job logs above." >> $GITHUB_STEP_SUMMARY
          fi
