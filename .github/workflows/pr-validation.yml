# PR Validation
#
# Fast validation for pull requests - only tests changed cookbooks.
# If shared infrastructure changes, tests all cookbooks.
#
# Uses Docker-based testing with self-contained Dockerfile.test for each cookbook.

name: PR Validation

on:
  pull_request:
    paths:
      - 'python/**'
      - 'node/**'
      - 'edge-cases/**'
      - 'multi-process/**'
      - 'self-hosted/**'
      - 'kubernetes/**'
      - 'shared/**'
      - '.github/workflows/**'

# Minimal permissions for security
permissions:
  contents: read
  actions: read
  pull-requests: read

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  # Detect which cookbooks changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      cookbooks: ${{ steps.detect.outputs.cookbooks }}
      test-all: ${{ steps.detect.outputs.test-all }}
      count: ${{ steps.detect.outputs.count }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed cookbooks
        id: detect
        run: |
          # Get changed files vs base branch
          git fetch origin ${{ github.base_ref }}
          changed=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          echo "Changed files:"
          echo "$changed"
          echo ""

          # If shared/ or .github/workflows/ changed, test all cookbooks with Dockerfile.test
          if echo "$changed" | grep -qE '^(shared/|\.github/workflows/)'; then
            echo "Shared infrastructure changed - testing all cookbooks"
            echo "test-all=true" >> $GITHUB_OUTPUT
            # Find all cookbooks with Dockerfile.test (excludes kubernetes)
            cookbooks=$(find . -name "Dockerfile.test" -not -path "./kubernetes/*" \
              -exec dirname {} \; | sed 's|^\./||' | sort | \
              jq -R -s -c 'split("\n")[:-1] | map({name: (.|gsub("/";"-")), path: .})')
            echo "cookbooks=$cookbooks" >> $GITHUB_OUTPUT
            echo "count=$(echo "$cookbooks" | jq 'length')" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Find affected cookbooks that have Dockerfile.test
          affected_dirs=$(echo "$changed" | \
            grep -E '^(python|node|edge-cases|multi-process|self-hosted)/' | \
            cut -d/ -f1-2 | \
            sort -u)

          cookbooks="[]"
          for dir in $affected_dirs; do
            if [ -f "$dir/Dockerfile.test" ]; then
              cookbooks=$(echo "$cookbooks" | jq --arg d "$dir" '. + [{name: ($d|gsub("/";"-")), path: $d}]')
            fi
          done

          echo "Affected cookbooks with Dockerfile.test:"
          echo "$cookbooks" | jq -r '.[].path'

          echo "cookbooks=$cookbooks" >> $GITHUB_OUTPUT
          echo "test-all=false" >> $GITHUB_OUTPUT
          echo "count=$(echo "$cookbooks" | jq 'length')" >> $GITHUB_OUTPUT

  # Test changed cookbooks using Docker
  test-changed:
    needs: detect-changes
    if: needs.detect-changes.outputs.count != '0'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        cookbook: ${{ fromJson(needs.detect-changes.outputs.cookbooks) }}

    steps:
      - name: Checkout cookbook repo
        uses: actions/checkout@v4
        with:
          path: oisp-cookbook

      - name: Checkout sensor repo
        uses: actions/checkout@v4
        with:
          repository: OximyHQ/oisp-sensor
          ref: main
          path: oisp-sensor
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        run: |
          COOKBOOK="${{ matrix.cookbook.path }}"
          IMAGE_NAME="oisp-test-$(echo $COOKBOOK | tr '/' '-'):latest"

          echo "Building: $IMAGE_NAME"
          docker build \
            -f "oisp-cookbook/$COOKBOOK/Dockerfile.test" \
            -t "$IMAGE_NAME" \
            --build-context oisp-sensor=oisp-sensor \
            --build-context oisp-cookbook=oisp-cookbook \
            .

      - name: Run test
        run: |
          COOKBOOK="${{ matrix.cookbook.path }}"
          IMAGE_NAME="oisp-test-$(echo $COOKBOOK | tr '/' '-'):latest"

          mkdir -p output

          echo "Running: $COOKBOOK"
          docker run --rm --privileged \
            -e OPENAI_API_KEY="$OPENAI_API_KEY" \
            -e ANTHROPIC_API_KEY="$ANTHROPIC_API_KEY" \
            -v "$(pwd)/output:/output" \
            "$IMAGE_NAME"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.cookbook.name }}
          path: output/
          retention-days: 7

  # Summary
  summary:
    needs: [detect-changes, test-changed]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## PR Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changes.outputs.test-all }}" = "true" ]; then
            echo "**Scope:** All cookbooks (shared infrastructure changed)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Scope:** Changed cookbooks only" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**Tested:** ${{ needs.detect-changes.outputs.count }} cookbook(s)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.test-changed.result }}" = "success" ]; then
            echo "✅ All tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some tests failed. Check job logs above." >> $GITHUB_STEP_SUMMARY
          fi
