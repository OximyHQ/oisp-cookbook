# Test Runner Dockerfile
#
# Builds the sensor and runs all cookbook tests in a Linux environment.
# This ensures eBPF capture works correctly.
#
# Usage:
#   docker build -f Dockerfile.test-runner -t oisp-test-runner ..
#   docker run --privileged \
#     -v /sys/kernel/debug:/sys/kernel/debug:rw \
#     -v /sys/fs/bpf:/sys/fs/bpf \
#     -e OPENAI_API_KEY=$OPENAI_API_KEY \
#     oisp-test-runner
#
# IMPORTANT: This must run on a Linux host (native or VM).
# Docker Desktop on macOS does NOT support eBPF uprobes.

# =============================================================================
# Stage 1: Build sslsniff (libbpf-based C binary)
# =============================================================================
FROM debian:bookworm-slim AS libbpf-builder

RUN apt-get update && apt-get install -y \
    build-essential \
    pkg-config \
    clang \
    llvm \
    libelf-dev \
    zlib1g-dev \
    make \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build

COPY oisp-sensor/bpftool ./bpftool
COPY oisp-sensor/bpf ./bpf
COPY oisp-sensor/vmlinux ./vmlinux

RUN cd bpftool/src && make -j$(nproc)

WORKDIR /build/bpf
RUN LIBBPF_SRC=/build/bpftool/libbpf/src \
    BPFTOOL_SRC=/build/bpftool/src \
    VMLINUX_DIR=/build/vmlinux \
    make clean && \
    LIBBPF_SRC=/build/bpftool/libbpf/src \
    BPFTOOL_SRC=/build/bpftool/src \
    VMLINUX_DIR=/build/vmlinux \
    make sslsniff && \
    cp sslsniff /usr/local/bin/

# =============================================================================
# Stage 2: Build Rust sensor
# =============================================================================
FROM rust:latest AS rust-builder

RUN apt-get update && apt-get install -y \
    build-essential \
    pkg-config \
    libssl-dev \
    lld \
    && rm -rf /var/lib/apt/lists/*

COPY --from=libbpf-builder /usr/local/bin/sslsniff /usr/local/bin/sslsniff

WORKDIR /build
COPY oisp-sensor/Cargo.toml oisp-sensor/Cargo.lock ./
COPY oisp-sensor/crates ./crates

# Create a minimal frontend/out directory (we don't need UI for tests)
RUN mkdir -p frontend/out && echo '{}' > frontend/out/placeholder.json

RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/build/target \
    RUSTFLAGS="-C link-arg=-fuse-ld=lld" \
    cargo build --release -p oisp-sensor && \
    cp target/release/oisp-sensor /usr/local/bin/

# =============================================================================
# Stage 3: Test Runner
# =============================================================================
FROM python:3.11-slim

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    libelf1 \
    zlib1g \
    libssl3 \
    procps \
    curl \
    nodejs \
    npm \
    && rm -rf /var/lib/apt/lists/*

# Copy sensor binary
COPY --from=rust-builder /usr/local/bin/oisp-sensor /usr/local/bin/

# Install Python test dependencies
RUN pip install --no-cache-dir openai litellm langchain langchain-openai httpx

# Copy cookbook
WORKDIR /cookbook
COPY oisp-cookbook/ ./

# Make scripts executable
RUN find . -name "*.sh" -exec chmod +x {} \;

# Test runner script
COPY <<'EOF' /run-tests.sh
#!/bin/bash
set -e

echo "=== OISP Cookbook Test Runner ==="
echo ""
echo "Sensor version: $(oisp-sensor --version)"
echo ""

# Check for API key
if [ -z "$OPENAI_API_KEY" ]; then
    echo "ERROR: OPENAI_API_KEY not set"
    exit 1
fi

# Run tests
FAILED=0

run_test() {
    local name=$1
    local path=$2

    echo ""
    echo "=== Testing $name ==="
    cd /cookbook/$path

    if ./test.sh; then
        echo "[PASS] $name"
    else
        echo "[FAIL] $name"
        FAILED=1
    fi
}

# Python examples
run_test "python/01-openai-simple" "python/01-openai-simple"
run_test "python/02-litellm" "python/02-litellm"
run_test "python/03-langchain-agent" "python/03-langchain-agent"
run_test "python/04-fastapi-service" "python/04-fastapi-service"

# Node examples
run_test "node/01-openai-simple" "node/01-openai-simple"

echo ""
echo "=== Summary ==="
if [ $FAILED -eq 0 ]; then
    echo "All tests passed!"
else
    echo "Some tests failed"
    exit 1
fi
EOF

RUN chmod +x /run-tests.sh

# Set sensor path for test scripts
ENV OISP_SENSOR_BIN=/usr/local/bin/oisp-sensor

CMD ["/run-tests.sh"]
