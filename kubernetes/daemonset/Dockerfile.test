# Test Dockerfile for Kubernetes DaemonSet manifests
#
# This test validates the Kubernetes manifests are syntactically correct
# and can be applied to a cluster. It does NOT test actual traffic capture
# since eBPF/uprobes don't work in nested container environments (CI).
#
# For full E2E testing, deploy to a real Kubernetes cluster.

# =============================================================================
# Manifest validator (lightweight - no sensor build needed)
# =============================================================================
FROM alpine:3.20

# Install kubectl for manifest validation
RUN apk add --no-cache \
    bash \
    curl \
    jq

# Install kubectl
RUN curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" && \
    chmod +x kubectl && \
    mv kubectl /usr/local/bin/

# Copy manifests
WORKDIR /test
COPY oisp-cookbook/kubernetes/daemonset/manifests/ ./manifests/

# Validation script
COPY <<'EOF' /test/run-test.sh
#!/bin/bash
set -e

echo "=== OISP Kubernetes DaemonSet Manifest Validation ==="
echo ""
echo "This test validates manifests are syntactically correct."
echo "For full E2E testing, deploy to a real Kubernetes cluster."
echo ""

# Create output dir
mkdir -p /output

ERRORS=0

# Validate each manifest file
echo "Validating manifests..."
for manifest in manifests/*.yaml; do
    echo -n "  $manifest: "

    # Check YAML syntax with kubectl
    if kubectl apply --dry-run=client -f "$manifest" > /dev/null 2>&1; then
        echo "✓ valid"
    else
        echo "✗ INVALID"
        kubectl apply --dry-run=client -f "$manifest" 2>&1 | head -5
        ERRORS=$((ERRORS + 1))
    fi
done

echo ""

# Check required files exist
echo "Checking required manifests exist..."
REQUIRED_FILES="namespace.yaml configmap.yaml daemonset.yaml"
for file in $REQUIRED_FILES; do
    echo -n "  $file: "
    if [ -f "manifests/$file" ]; then
        echo "✓ exists"
    else
        echo "✗ MISSING"
        ERRORS=$((ERRORS + 1))
    fi
done

echo ""

# Validate DaemonSet has required fields
echo "Validating DaemonSet structure..."
if [ -f manifests/daemonset.yaml ]; then
    # Check for hostPID (required for eBPF)
    echo -n "  hostPID: "
    if grep -q "hostPID: true" manifests/daemonset.yaml; then
        echo "✓ enabled"
    else
        echo "✗ not enabled (required for eBPF)"
        ERRORS=$((ERRORS + 1))
    fi

    # Check for privileged security context
    echo -n "  privileged: "
    if grep -q "privileged: true" manifests/daemonset.yaml; then
        echo "✓ enabled"
    else
        echo "✗ not enabled (required for eBPF)"
        ERRORS=$((ERRORS + 1))
    fi

    # Check for BPF capability
    echo -n "  CAP_BPF: "
    if grep -q "BPF" manifests/daemonset.yaml; then
        echo "✓ present"
    else
        echo "⚠ not found (may work with privileged)"
    fi

    # Check for bpf volume mount
    echo -n "  /sys/fs/bpf mount: "
    if grep -q "/sys/fs/bpf" manifests/daemonset.yaml; then
        echo "✓ present"
    else
        echo "✗ missing (required for eBPF)"
        ERRORS=$((ERRORS + 1))
    fi
fi

echo ""

# Summary
if [ $ERRORS -eq 0 ]; then
    echo "=== VALIDATION PASSED ==="
    echo ""
    echo "All manifests are valid and contain required configurations."
    echo "Deploy to a real Kubernetes cluster for full E2E testing."
    exit 0
else
    echo "=== VALIDATION FAILED ==="
    echo ""
    echo "Found $ERRORS error(s). Please fix the issues above."
    exit 1
fi
EOF

RUN chmod +x /test/run-test.sh

CMD ["/test/run-test.sh"]
