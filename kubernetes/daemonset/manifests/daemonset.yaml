apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: oisp-sensor
  namespace: oisp-sensor
  labels:
    app.kubernetes.io/name: oisp-sensor
    app.kubernetes.io/component: observability
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: oisp-sensor
  template:
    metadata:
      labels:
        app.kubernetes.io/name: oisp-sensor
    spec:
      # Run on all nodes including control plane
      tolerations:
        - operator: Exists

      # Use host namespaces for eBPF visibility
      hostPID: true
      hostNetwork: true

      containers:
        - name: sensor
          image: ghcr.io/oximyhq/sensor:latest
          imagePullPolicy: Always

          # Sensor command
          args:
            - record
            - --output
            - /output/events.jsonl

          # Security context for eBPF
          securityContext:
            privileged: true
            capabilities:
              add:
                - SYS_ADMIN
                - SYS_PTRACE
                - NET_ADMIN
                - BPF

          # Resource limits
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"

          # Volume mounts
          volumeMounts:
            # Output directory (persistent)
            - name: output
              mountPath: /output

            # eBPF filesystem (required)
            - name: bpf
              mountPath: /sys/fs/bpf

            # Debug filesystem (required for kprobes)
            - name: debug
              mountPath: /sys/kernel/debug
              readOnly: true

            # Configuration (optional)
            - name: config
              mountPath: /etc/oisp-sensor
              readOnly: true

          # Readiness probe - check if sensor process is running
          # Note: We check for the process, not the output file, since events.jsonl
          # only appears after traffic is captured
          readinessProbe:
            exec:
              command:
                - pgrep
                - -f
                - oisp-sensor
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 3

          # Liveness probe - check process is still alive
          livenessProbe:
            exec:
              command:
                - pgrep
                - -f
                - oisp-sensor
            initialDelaySeconds: 30
            periodSeconds: 30
            failureThreshold: 3

      volumes:
        # Output directory - using hostPath for simplicity
        # In production, use a PersistentVolume or ship to remote storage
        - name: output
          hostPath:
            path: /var/log/oisp-sensor
            type: DirectoryOrCreate

        # eBPF filesystem
        - name: bpf
          hostPath:
            path: /sys/fs/bpf
            type: Directory

        # Debug filesystem
        - name: debug
          hostPath:
            path: /sys/kernel/debug
            type: Directory

        # Configuration from ConfigMap
        - name: config
          configMap:
            name: oisp-sensor-config
