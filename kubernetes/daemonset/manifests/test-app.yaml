# Test application for validating sensor captures
# Uses curl which links against system libssl.so (capturable by sslsniff)

apiVersion: batch/v1
kind: Job
metadata:
  name: test-app
  namespace: oisp-sensor
  labels:
    app.kubernetes.io/name: test-app
spec:
  backoffLimit: 2
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app.kubernetes.io/name: test-app
    spec:
      restartPolicy: Never
      containers:
        - name: app
          # Use debian which has curl linked against system libssl.so
          image: debian:bookworm-slim
          command:
            - /bin/bash
            - -c
            - |
              set -e

              # Install curl (uses system libssl)
              apt-get update -qq && apt-get install -qq -y curl jq > /dev/null

              echo "Making OpenAI API call with curl..."
              echo "curl version: $(curl --version | head -1)"

              # Check which SSL library curl uses
              echo "SSL libraries:"
              ldd $(which curl) | grep -i ssl || echo "No SSL in ldd"

              # Make the API call
              RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d '{
                  "model": "gpt-4o-mini",
                  "messages": [{"role": "user", "content": "Say hello in exactly 3 words."}]
                }')

              echo "Response received!"
              echo "$RESPONSE" | jq -r '.choices[0].message.content' 2>/dev/null || echo "$RESPONSE"

              # Make a second call to ensure we have enough events
              echo ""
              echo "Making second API call..."
              curl -s https://api.openai.com/v1/models \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                | jq -r '.data[0].id' 2>/dev/null || echo "Second call done"

              echo ""
              echo "Done!"
          env:
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: openai-api-key
                  key: OPENAI_API_KEY
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
