# Test Dockerfile for OpenShift DaemonSet manifests
#
# This test validates the OpenShift manifests are syntactically correct
# and contain required eBPF/SCC configurations. It does NOT test actual traffic
# capture since eBPF/uprobes don't work in nested container environments (CI).
#
# For full E2E testing, deploy to a real OpenShift cluster.

# =============================================================================
# Manifest validator (lightweight - no sensor build needed)
# =============================================================================
FROM python:3.12-alpine

# Install dependencies
RUN pip install --no-cache-dir pyyaml

# Copy manifests
WORKDIR /test
COPY oisp-cookbook/openshift/daemonset/manifests/ ./manifests/

# Validation script
COPY <<'EOF' /test/run-test.sh
#!/usr/bin/env python3
"""
OpenShift manifest validation script.
Validates YAML syntax and required eBPF/SCC configurations.
"""

import sys
import os
import yaml
from pathlib import Path

def main():
    print("=== OISP OpenShift DaemonSet Manifest Validation ===")
    print()
    print("This test validates manifests are syntactically correct.")
    print("For full E2E testing, deploy to a real OpenShift cluster.")
    print()

    # Create output dir
    Path("/output").mkdir(exist_ok=True)

    errors = 0
    manifests_dir = Path("manifests")

    # Validate YAML syntax
    print("Validating YAML syntax...")
    for manifest in sorted(manifests_dir.glob("*.yaml")):
        print(f"  {manifest}: ", end="")
        try:
            with open(manifest) as f:
                docs = list(yaml.safe_load_all(f))
            if docs and docs[0]:
                print("✓ valid")
            else:
                print("⚠ empty")
        except yaml.YAMLError as e:
            print("✗ INVALID")
            print(f"    {e}")
            errors += 1

    print()

    # Check required files
    print("Checking required manifests exist...")
    required = ["namespace.yaml", "configmap.yaml", "daemonset.yaml", "scc.yaml", "service-account.yaml"]
    for filename in required:
        print(f"  {filename}: ", end="")
        if (manifests_dir / filename).exists():
            print("✓ exists")
        else:
            print("✗ MISSING")
            errors += 1

    print()

    # Validate DaemonSet structure
    print("Validating DaemonSet structure...")
    daemonset_file = manifests_dir / "daemonset.yaml"
    if daemonset_file.exists():
        with open(daemonset_file) as f:
            content = f.read()

        # Check hostPID
        print("  hostPID: ", end="")
        if "hostPID: true" in content:
            print("✓ enabled")
        else:
            print("✗ not enabled (required for eBPF)")
            errors += 1

        # Check privileged
        print("  privileged: ", end="")
        if "privileged: true" in content:
            print("✓ enabled")
        else:
            print("✗ not enabled (required for eBPF)")
            errors += 1

        # Check BPF capability
        print("  CAP_BPF: ", end="")
        if "BPF" in content:
            print("✓ present")
        else:
            print("⚠ not found (may work with privileged)")

        # Check bpf mount
        print("  /sys/fs/bpf mount: ", end="")
        if "/sys/fs/bpf" in content:
            print("✓ present")
        else:
            print("✗ missing (required for eBPF)")
            errors += 1

        # Check serviceAccountName
        print("  serviceAccountName: ", end="")
        if "serviceAccountName:" in content:
            print("✓ present")
        else:
            print("⚠ not found (required for SCC)")

    print()

    # Validate SCC structure
    print("Validating SCC structure...")
    scc_file = manifests_dir / "scc.yaml"
    if scc_file.exists():
        with open(scc_file) as f:
            content = f.read()

        print("  allowPrivilegedContainer: ", end="")
        if "allowPrivilegedContainer: true" in content:
            print("✓ enabled")
        else:
            print("✗ not enabled")
            errors += 1

        print("  allowHostPID: ", end="")
        if "allowHostPID: true" in content:
            print("✓ enabled")
        else:
            print("✗ not enabled")
            errors += 1

    print()

    # Summary
    if errors == 0:
        print("=== VALIDATION PASSED ===")
        print()
        print("All manifests are valid and contain required configurations.")
        print("Deploy to a real OpenShift cluster for full E2E testing.")
        return 0
    else:
        print("=== VALIDATION FAILED ===")
        print()
        print(f"Found {errors} error(s). Please fix the issues above.")
        return 1

if __name__ == "__main__":
    sys.exit(main())
EOF

RUN chmod +x /test/run-test.sh

CMD ["python3", "/test/run-test.sh"]
