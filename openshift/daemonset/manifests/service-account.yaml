# ServiceAccount and RBAC for OISP Sensor
#
# This creates:
# 1. ServiceAccount - Identity for sensor pods
# 2. ClusterRole - Permissions to read pods/nodes for metadata enrichment
# 3. ClusterRoleBinding - Binds the role to the ServiceAccount
#
# Note: The SCC binding is handled in scc.yaml via the 'users' field

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: oisp-sensor
  namespace: oisp-sensor
  labels:
    app.kubernetes.io/name: oisp-sensor
    app.kubernetes.io/component: observability

---
# ClusterRole for reading pod and node metadata
# This allows the sensor to enrich events with Kubernetes context
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: oisp-sensor
  labels:
    app.kubernetes.io/name: oisp-sensor
    app.kubernetes.io/component: observability
rules:
  # Read pods to correlate events with pod metadata
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  # Read nodes to get node-level metadata
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch"]
  # Read namespaces for context
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list"]

---
# Bind the ClusterRole to the ServiceAccount
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: oisp-sensor
  labels:
    app.kubernetes.io/name: oisp-sensor
    app.kubernetes.io/component: observability
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: oisp-sensor
subjects:
  - kind: ServiceAccount
    name: oisp-sensor
    namespace: oisp-sensor
